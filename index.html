<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POS Print Test</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; padding: 50px; background: #f4f4f4; }
  button { padding: 15px 30px; font-size: 18px; cursor: pointer; border: none; border-radius: 6px; background: #28a745; color: #fff; }
  button:hover { background: #218838; }
  #status { margin-top: 20px; font-size: 16px; color: #333; }
</style>
</head>
<body>

<h1>POS Order Print Test</h1>
<button onclick="sendAndPrint()">Send Order & Print</button>
<div id="status">Waiting...</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // üîß Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyCirYQ_46JiSkMIwCNs1nSi89dvB1MUg_A",
    authDomain: "deliverylog12.firebaseapp.com",
    databaseURL: "https://deliverylog12-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "deliverylog12",
    storageBucket: "deliverylog12.firebasestorage.app",
    messagingSenderId: "19081371357",
    appId: "1:19081371357:web:b9b59e732a4d90d4d44534",
    measurementId: "G-FSZXXZQSL0"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Sample order (80mm receipt width compatible)
  const orderItems = [
    { name: "Burger", qty: 2, price: 5 },
    { name: "Coke", qty: 1, price: 2 },
    { name: "Fries", qty: 1, price: 3 }
  ];

  const totalPrice = orderItems.reduce((sum, item) => sum + item.qty * item.price, 0);

  const statusEl = document.getElementById("status");

  async function sendAndPrint() {
    statusEl.textContent = "‚è≥ Sending order to Firebase...";
    
    try {
      // 1Ô∏è‚É£ Send order to Firestore
      const docRef = await addDoc(collection(db, "orders"), {
        table: "Test Table",
        items: orderItems,
        total: totalPrice,
        status: "pending",
        createdAt: new Date().toISOString()
      });
      statusEl.textContent = `‚úÖ Order sent! ID: ${docRef.id}`;
    } catch (err) {
      console.error(err);
      statusEl.textContent = "‚ùå Error sending order: " + err.message;
      return;
    }

    // 2Ô∏è‚É£ Print to Epson (only works on desktop/laptop with same LAN)
    const printerIp = "192.168.0.111"; // your printer IP
    const ePosDev = new epson.ePOSDevice();

    statusEl.textContent += " | Connecting to printer...";

    ePosDev.connect(printerIp, 8008, function(res) {
      if (res === "OK" || res === "SSL_CONNECT_OK") {
        statusEl.textContent += " ‚úÖ Printer connected";

        ePosDev.createDevice('local_printer', ePosDev.DEVICE_TYPE_PRINTER, {crypto:false, buffer:false}, function(printerObj, code){
          if (!printerObj) {
            statusEl.textContent += " ‚ùå Printer object failed: " + code;
            return;
          }

          const printer = printerObj;
          printer.addTextAlign(printer.ALIGN_CENTER);
          printer.addText("*** ORDER RECEIPT ***\n");
          printer.addFeedLine(1);
          printer.addTextAlign(printer.ALIGN_LEFT);

          orderItems.forEach(item => {
            let line = `${item.name.padEnd(12,' ')} x${item.qty}  $${item.qty*item.price}`;
            printer.addText(line + "\n");
          });

          printer.addText("------------------------\n");
          printer.addTextAlign(printer.ALIGN_RIGHT);
          printer.addText(`TOTAL: $${totalPrice}\n`);
          printer.addFeedLine(3);
          printer.addCut(printer.CUT_FEED);
          printer.send();

          statusEl.textContent += " üñ®Ô∏è Print job sent!";
        });

      } else {
        statusEl.textContent += " ‚ùå Printer connection failed: " + res;
      }
    });
  }

  window.sendAndPrint = sendAndPrint;
</script>

<!-- Epson ePOS SDK -->
<script src="https://download.epson-biz.com/modules/pos/reference/epos-2.31.0.js"></script>
</body>
</html>
