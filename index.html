<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POS Order + Print Test</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
  h1 { text-align: center; }
  table { width: 100%; max-width: 400px; margin: 20px auto; border-collapse: collapse; background: #fff; }
  th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
  th { background-color: #eee; }
  button { padding: 10px 20px; margin: 10px; cursor: pointer; border: none; border-radius: 5px; background: #28a745; color: white; }
  button:hover { background: #218838; }
  #status { text-align: center; margin-top: 15px; color: #555; }
</style>
</head>
<body>

<h1>POS Order Test</h1>

<table id="orderTable">
  <thead>
    <tr>
      <th>Item</th>
      <th>Qty</th>
      <th>Price</th>
    </tr>
  </thead>
  <tbody id="orderBody"></tbody>
  <tfoot>
    <tr>
      <th>Total</th>
      <th></th>
      <th id="totalPrice">$0</th>
    </tr>
  </tfoot>
</table>

<div style="text-align:center;">
  <button onclick="sendOrder()">Send Order</button>
  <button onclick="printOrder()">Print Order</button>
</div>

<div id="status">Waiting...</div>

<script type="module">
  // Firebase SDK
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // üîß Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCirYQ_46JiSkMIwCNs1nSi89dvB1MUg_A",
    authDomain: "deliverylog12.firebaseapp.com",
    databaseURL: "https://deliverylog12-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "deliverylog12",
    storageBucket: "deliverylog12.firebasestorage.app",
    messagingSenderId: "19081371357",
    appId: "1:19081371357:web:b9b59e732a4d90d4d44534",
    measurementId: "G-FSZXXZQSL0"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Sample order
  const orderItems = [
    { name: "Burger", qty: 2, price: 5 },
    { name: "Coke", qty: 1, price: 2 },
    { name: "Fries", qty: 1, price: 3 }
  ];

  // Show order in table
  const orderBody = document.getElementById("orderBody");
  const totalPriceEl = document.getElementById("totalPrice");
  let totalPrice = 0;

  orderItems.forEach(item => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${item.name}</td><td>${item.qty}</td><td>$${item.qty * item.price}</td>`;
    orderBody.appendChild(tr);
    totalPrice += item.qty * item.price;
  });

  totalPriceEl.textContent = `$${totalPrice}`;

  const statusEl = document.getElementById("status");

  // Send order to Firebase
  async function sendOrder() {
    statusEl.textContent = "Sending order...";
    try {
      const docRef = await addDoc(collection(db, "orders"), {
        table: "Test Table",
        items: orderItems,
        total: totalPrice,
        status: "pending",
        createdAt: new Date().toISOString()
      });
      statusEl.textContent = `‚úÖ Order sent! ID: ${docRef.id}`;
    } catch (err) {
      console.error(err);
      statusEl.textContent = "‚ùå Error sending order";
    }
  }

  // Print order (using Epson ePOS SDK on desktop / LAN)
  function printOrder() {
    const printerIp = "192.168.0.111"; // Change to your printer IP
    const ePosDev = new epson.ePOSDevice();

    ePosDev.connect(printerIp, 8008, function(res) {
      if (res === "OK" || res === "SSL_CONNECT_OK") {
        ePosDev.createDevice('local_printer', ePosDev.DEVICE_TYPE_PRINTER, { crypto:false, buffer:false }, function(printerObj, code){
          if(!printerObj){
            alert("Printer connection failed: " + code);
            return;
          }

          const printer = printerObj;
          printer.addTextAlign(printer.ALIGN_CENTER);
          printer.addText("*** ORDER RECEIPT ***\n\n");
          printer.addTextAlign(printer.ALIGN_LEFT);

          orderItems.forEach(item => {
            printer.addText(`${item.name} x${item.qty}  $${item.qty * item.price}\n`);
          });

          printer.addText("--------------------\n");
          printer.addTextAlign(printer.ALIGN_RIGHT);
          printer.addText(`TOTAL: $${totalPrice}\n`);
          printer.addFeedLine(2);
          printer.addCut(printer.CUT_FEED);
          printer.send();
          statusEl.textContent = "üñ®Ô∏è Print job sent!";
        });
      } else {
        alert("Connection failed: " + res);
      }
    });
  }
</script>

<!-- Epson ePOS SDK -->
<script src="https://download.epson-biz.com/modules/pos/reference/epos-2.31.0.js"></script>
</body>
</html>
